{% extends "base.html" %} {% block title %}Code Walkers{% endblock %}
<!--content-->
{% block content %}
<h2>Room: {{ game.room_name }}</h2>
<p>User: {{ request.user.username }}</p>

{% if game.state == "won" %}
<h3>Winner: {{ game.winner }}</h3>
{% elif game.state == "tie" %}
<h3>It's a tie!</h3>
{% else %}
<h3>Turn: {{ game.active_player }}</h3>
{% endif %}

<div style="display: grid; grid-template-columns: repeat(3, 80px); gap: 5px">
  {% for cell in board_cells %}
  <button
    name="cell"
    value="{{ forloop.counter0 }}"
    style="height: 80px; font-size: 2em"
  >
    {% if cell == "_" %} ‚¨ú {% elif cell == "X" %} ‚ùå {% else %} ‚≠ï
    <!-- separator -->
    {% endif %}
  </button>
  {% endfor %}
</div>

<!-- kill room -->

{% if request.user == game.player_x %}
<a href="?delete=1">üóëÔ∏è Close Room</a>
{% endif %}

<div
  id="chat-container"
  class="mt-8 w-full max-w-md bg-gray-900 border border-gray-700 rounded-xl shadow-xl"
>
  <!-- Chat Messages -->
  <div
    id="chat-messages"
    class="h-64 overflow-y-auto p-4 flex flex-col gap-3"
  ></div>

  <!-- Input -->
  <div class="flex border-t border-gray-700">
    <input
      id="chat-input"
      type="text"
      maxlength="300"
      placeholder="Escribe un mensaje..."
      class="flex-1 px-3 py-2 bg-gray-800 text-gray-200 placeholder-gray-500 focus:outline-none rounded-bl-xl"
    />

    <button
      id="send-btn"
      class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-br-xl"
    >
      Enviar
    </button>
  </div>
</div>

<script>
  const roomName = "{{ game.room_name }}";
  const userName = "{{ request.user.username }}";

  const gameSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/game/" + roomName + "/"
  );

  // RECEIVE FROM SV ::
  gameSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    if (data.type === "game_state") {
      const game = data.game;

      // Update bard {not recharge}

      game.board.split("").forEach((cell, index) => {
        const btn = document.querySelector(`button[value='${index}']`);
        if (!btn) return;
        btn.textContent = cell === "_" ? "‚¨ú" : cell === "X" ? "‚ùå" : "‚≠ï";
      });

      // Update turn and winner

      const turnEl = document.querySelector("#turn");
      if (turnEl) turnEl.textContent = `Turn: ${game.active_player}`;
      const winnerEl = document.querySelector("#winner");
      if (winnerEl)
        winnerEl.textContent =
          game.state === "won" ? `Winner: ${game.winner}` : "";
    }
  };

  // Handle socket closure

  gameSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly");
  };

  // Send moves to the server

  document.querySelectorAll("button[name='cell']").forEach((btn) => {
    btn.addEventListener("click", (event) => {
      event.preventDefault(); // evita recargar la p√°gina
      const cell = btn.value;
      gameSocket.send(JSON.stringify({ type: "move", cell }));
    });
  });

  // CHAT UI LOGIC ::
  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");

  // Send
  function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;

    gameSocket.send(
      JSON.stringify({
        type: "chat",
        message: msg,
      })
    );
    chatInput.value = "";
  }

  // 'Enter' event
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  // 'Click' event
  sendBtn.addEventListener("click", sendMessage);

  // Receive
  gameSocket.addEventListener("message", (e) => {
    const data = JSON.parse(e.data);

    if (data.type === "chat") {
      const div = document.createElement("div");

      if (data.username === userName) {
        div.classList =
          "self-end max-w-xs bg-blue-600 text-white px-3 py-2 rounded-lg";
      } else {
        div.classList =
          "self-start max-w-xs bg-gray-700 text-gray-200 px-3 py-2 rounded-lg";
      }

      // Display

      div.innerHTML = `<strong>${data.username}</strong><br>${data.message}`;
      chatMessages.appendChild(div);

      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  });
</script>

{% endblock %}
